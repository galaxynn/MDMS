1. # 电影资料库管理系统 (MDMS) - 设计文档

   ## 1. 简介

   本文档旨在设计一个严谨、可扩展的电影资料库管理系统。系统不仅管理电影、演职人员和用户评论，还规范了实体间的关系、核心业务逻辑以及配套的 API 架构。

   ## 2. 核心设计原则

   1. **实体抽象化**：将“演员 (Actors)”和“导演 (Directors)”统一抽象为“**参与人 (People)**”实体。这解决了一个人可能同时拥有多个身份（如演员、导演、编剧）的问题，使数据结构更具弹性和真实性。
   2. **关系清晰化**：使用清晰的连接表 (Join Tables) 来处理多对多 (M:N) 关系，例如一部电影有多个类型、多个参与人。
   3. **数据一致性**：通过在“电影”表中冗余存储“平均分”和“评论数”来优化读取性能，并通过业务逻辑（如触发器或应用层服务）在评论变更时更新这些值，确保数据的一致性。
   4. **角色权限分离**：明确定义“普通用户 (User)”和“管理员 (Admin)”的权限边界。

   ## 3. 数据实体与关系 (ERD)

   系统包含以下核心实体和关系：

   - **Users (用户)**：系统的使用者。
   - **People (参与人)**：指代所有电影的演职人员（演员、导演、编剧等）。
   - **Movies (电影)**：资料库的核心实体。
   - **Reviews (影评)**：用户对电影的评价。
   - **Genres (类型)**：电影的分类标签。

   **实体间关系：**

   1. `Users` (1) <-> (N) `Reviews`：一个用户可以发布多条影评；一条影评只属于一个用户。
   2. `Movies` (1) <-> (N) `Reviews`：一部电影可以有多条影评；一条影评只针对一部电影。
   3. `Movies` (M) <-> (N) `Genres`：一部电影可分属多个类型；一个类型可包含多部电影。 (通过 `MovieGenres` 连接表)
   4. `Movies` (M) <-> (N) `People`：一部电影有多位参与人；一位参与人可参与多部电影。 (通过 `MovieCrew` 连接表)

   ## 4. 数据库表结构 (Schema)

   为保证严谨性，我们使用 `_id` 作为主键 (PK)，并明确外键 (FK) 约束。

   ### 4.1. Users (用户表)

   | **字段名**      | **类型**              | **约束**                  | **描述**     |
   | --------------- | --------------------- | ------------------------- | ------------ |
   | `user_id`       | UUID                  | PK                        | 唯一用户 ID  |
   | `username`      | VARCHAR(100)          | UNIQUE, NOT NULL          | 用户名       |
   | `email`         | VARCHAR(255)          | UNIQUE, NOT NULL          | 邮箱         |
   | `password_hash` | VARCHAR(255)          | NOT NULL                  | 加密后的密码 |
   | `role`          | ENUM('user', 'admin') | NOT NULL, DEFAULT 'user'  | 用户角色     |
   | `created_at`    | TIMESTAMP             | DEFAULT CURRENT_TIMESTAMP | 注册时间     |

   ### 4.2. People (参与人表)

   | **字段名**  | **类型**      | **约束** | **描述**      |
   | ----------- | ------------- | -------- | ------------- |
   | `person_id` | UUID          | PK       | 唯一参与人 ID |
   | `name`      | VARCHAR(255)  | NOT NULL | 姓名          |
   | `bio`       | TEXT          |          | 简介          |
   | `birthdate` | DATE          |          | 出生日期      |
   | `photo_url` | VARCHAR(1024) |          | 照片链接      |

   ### 4.3. Genres (类型表)

   | **字段名** | **类型**     | **约束**           | **描述**                  |
   | ---------- | ------------ | ------------------ | ------------------------- |
   | `genre_id` | INT          | PK, AUTO_INCREMENT | 类型 ID                   |
   | `name`     | VARCHAR(100) | UNIQUE, NOT NULL   | 类型名称 (如：科幻, 剧情) |

   ### 4.4. Movies (电影表)

   | **字段名**        | **类型**      | **约束**               | **描述**                     |
   | ----------------- | ------------- | ---------------------- | ---------------------------- |
   | `movie_id`        | UUID          | PK                     | 唯一电影 ID                  |
   | `title`           | VARCHAR(255)  | NOT NULL               | 电影标题                     |
   | `synopsis`        | TEXT          |                        | 剧情简介                     |
   | `release_date`    | DATE          |                        | 上映日期                     |
   | `runtime_minutes` | INT           |                        | 电影时长（分钟）             |
   | `country`         | VARCHAR(50)   |                        | 制片国家/地区                |
   | `language`        | VARCHAR(50)   |                        | 电影语言                     |
   | `poster_url`      | VARCHAR(1024) |                        | 海报链接                     |
   | `average_rating`  | DECIMAL(3, 2) | NOT NULL, DEFAULT 0.00 | 平均分（冗余存储以优化查询） |
   | `rating_count`    | INT           | NOT NULL, DEFAULT 0    | 评分人数（冗余存储）         |

   

   ### 4.5. Reviews (影评表)

   | **字段名**           | **类型**  | **约束**                   | **描述**                                |
   | -------------------- | --------- | -------------------------- | --------------------------------------- |
   | `review_id`          | UUID      | PK                         | 唯一影评 ID                             |
   | `movie_id`           | UUID      | FK -> Movies(movie_id)     | 关联的电影 ID                           |
   | `user_id`            | UUID      | FK -> Users(user_id)       | 发布的用户 ID                           |
   | `rating`             | INT       | NOT NULL (1-10)            | 评分（1-10分制）                        |
   | `comment`            | TEXT      |                            | 评论内容                                |
   | `created_at`         | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP  | 发布时间                                |
   | uq_user_movie_review | 约束      | UNIQUE (user_id, movie_id) | 复合唯一约束,保证了“一人一票”的业务规则 |

   ### 4.6. Movie_Genres (电影-类型 连接表)

   (M:N 关系表)

   | **字段名** | **类型** | **约束**                | **描述** |
   | ---------- | -------- | ----------------------- | -------- |
   | `movie_id` | UUID     | FK -> Movies(movie_id)  | 电影 ID  |
   | `genre_id` | INT      | FK -> Genres(genre_id)  | 类型 ID  |
   |            |          | PK (movie_id, genre_id) | 复合主键 |

   ### 4.7. Movie_Crew (电影-参与人 连接表)

   (M:N 关系表，核心设计)

   | **字段名**       | **类型**                                        | **约束**                | **描述**                              |
   | ---------------- | ----------------------------------------------- | ----------------------- | ------------------------------------- |
   | `crew_id`        | UUID                                            | PK                      | 唯一记录 ID                           |
   | `movie_id`       | UUID                                            | FK -> Movies(movie_id)  | 电影 ID                               |
   | `person_id`      | UUID                                            | FK -> People(person_id) | 参与人 ID                             |
   | `role`           | ENUM('Director', 'Actor', 'Writer', 'Producer') | NOT NULL                | 职责（可扩展）                        |
   | `character_name` | VARCHAR(255)                                    |                         | (可选) 角色名（仅当 role='Actor' 时） |

   ## 5. 核心功能与 API 端点设计（可忽视）

   以下是基于 RESTful 风格的 API 端点设计，以实现核心功能。

   ### 5.1. 用户认证 (Auth)

   - `POST /api/auth/register`：用户注册。
   - `POST /api/auth/login`：用户登录（返回 JWT Token）。
   - `GET /api/auth/me`：(需认证) 获取当前用户信息。

   ### 5.2. 电影 (Movies)

   - `GET /api/movies`：**搜索/浏览电影**。
     - `?q={title}`：按名称搜索。
     - `?genre={genre_name}`：按类型搜索。
     - `?actor={person_name}`：按演员搜索 (JOIN MovieCrew & People)。
     - `?director={person_name}`：按导演搜索 (JOIN MovieCrew & People)。
     - `?sort={avg_rating_desc|release_date_desc}`：排序方式。
     - `?page={num}&limit={size}`：分页。
   - `GET /api/movies/top100`：**Top 100 榜单**。
     - (内部实现为 `GET /api/movies?sort=avg_rating_desc&limit=100`)。
   - `GET /api/movies/{movie_id}`：**查看电影详情**。
     - (返回电影信息，并聚合 genres, crew (actors, directors), reviews 列表)。
   - `POST /api/movies`：(Admin) 添加新电影。
   - `PUT /api/movies/{movie_id}`：(Admin) 修改电影信息。
   - `DELETE /api/movies/{movie_id}`：(Admin) 删除电影。

   ### 5.3. 参与人 (People)

   - `GET /api/people/{person_id}`：**查看参与人信息**。
     - (返回 People 详情，并聚合其作品列表 Filmography (JOIN MovieCrew & Movies))。
   - `POST /api/people`：(Admin) 添加参与人。
   - `PUT /api/people/{person_id}`：(Admin) 修改参与人信息。

   ### 5.4. 影评 (Reviews)

   - `GET /api/movies/{movie_id}/reviews`：查看某电影的所有影评（分页）。
   - `POST /api/movies/{movie_id}/reviews`：(User) **发布影评/打分**。
     - (需认证)。
     - **[核心逻辑]**：此 API 成功执行后，必须触发一个后台任务或数据库触发器，以重新计算 `Movies` 表中对应 `movie_id` 的 `average_rating` 和 `rating_count` 字段。
   - `DELETE /api/reviews/{review_id}`：(User/Admin) 删除影评。
     - (User 只能删除自己的，Admin 可以删除任意的)。
     - **[核心逻辑]**：删除后同样需要触发 `Movies` 表的平均分更新。

   ### 5.5. 管理 (Admin)

   - `POST /api/movies/{movie_id}/crew`：(Admin) 为电影添加演职人员。
   - `DELETE /api/movies/{movie_id}/crew/{crew_id}`：(Admin) 移除演职人员。
   - `POST /api/movies/{movie_id}/genres`：(Admin) 为电影添加类型。
   - `DELETE /api/movies/{movie_id}/genres/{genre_id}`：(Admin) 移除电影类型。
   - `GET /api/users`：(Admin) 查看用户列表。

   ## 6. 补充功能与考量 (扩展)

   1. **数据源 (Data Source)**：系统需要一个初始数据填充机制。管理员功能是基础，但未来可考虑集成 TMDB 或 IMDb 等第三方 API 来自动拉取和更新电影数据。
   2. **搜索优化 (Search)**：当数据量巨大时，基于 `LIKE` 和 `JOIN` 的搜索会变得缓慢。应引入全文搜索引擎（如 Elasticsearch 或 MeiliSearch）来处理 `GET /api/movies` 的复杂查询。
   3. **缓存 (Caching)**：像 "Top 100 榜单" 和电影详情页这种高频访问且不常变动的数据，应使用 Redis 进行缓存，以降低数据库压力。
   4. **异步任务 (Async Tasks)**：更新电影平均分的操作（`average_rating`）可以放入消息队列（如 RabbitMQ）中异步处理，避免在用户提交评论时造成API堵塞。
   5. **扩展的参与人角色**：`MovieCrew` 表中的 `role` 字段可以轻松扩展，加入 '编剧 (Writer)', '制片人 (Producer)', '配乐 (Composer)' 等，使资料库更加专业。



### 可优化点与建议

#### 1. 强烈推荐 (Crucial) - 保证数据完整性和核心逻辑

这些是几乎在任何生产环境中都应该考虑的关键点。

##### **1.1. 影评的唯一性约束**
- **问题**: 当前设计允许同一个用户对同一部电影发布多条影评。这通常不符合业务逻辑。
- **解决方案**: 在 `Reviews` 表上增加一个复合唯一约束。
- **实施**:
  ```sql
  ALTER TABLE Reviews
  ADD CONSTRAINT uq_user_movie_review UNIQUE (user_id, movie_id);
  ```
- **推荐程度**: ★★★★★ (强烈推荐)
- **理由**: 从根本上保证了“一人一票”的业务规则，避免了数据污染和后续复杂的逻辑判断。

##### **1.2. 冗余数据更新的事务性**
- **问题**: 你提到了通过业务逻辑更新 `Movies` 表的 `average_rating` 和 `rating_count`。这是一个很好的性能优化，但必须保证操作的原子性。
- **解决方案**: 无论是使用触发器还是在应用层服务中处理，**更新操作必须放在一个数据库事务 (Transaction) 中**。
- **实施 (应用层伪代码)**:
  ```
  BEGIN TRANSACTION;
  
  // 1. 插入新的 Review
  INSERT INTO Reviews (movie_id, user_id, rating, ...) VALUES (...);
  
  // 2. 重新计算平均分和总数
  new_avg = SELECT AVG(rating) FROM Reviews WHERE movie_id = ?;
  new_count = SELECT COUNT(*) FROM Reviews WHERE movie_id = ?;
  
  // 3. 更新 Movies 表
  UPDATE Movies SET average_rating = new_avg, rating_count = new_count WHERE movie_id = ?;
  
  COMMIT;
  ```
- **推荐程度**: ★★★★★ (强烈推荐)
- **理由**: 防止在并发写入时出现数据不一致。例如，一个用户刚提交评论，但更新 `Movies` 表失败了，会导致 `Movies` 表的数据是旧的、错误的。

---

#### 2. 高度推荐 (High Priority) - 提升性能和健壮性

##### **2.1. 数据库索引 (Indexing)**
- **问题**: 当前设计只定义了主键和外键，但没有为高频查询字段建立索引，这将导致查询性能瓶颈。
- **解决方案**: 为经常用于 `WHERE`、`JOIN`、`ORDER BY` 的字段添加索引。
- **实施**:
  - `Movies(title)`: 用户会频繁按标题搜索电影。
  - `People(name)`: 用户会频繁按姓名搜索参与人。
  - `Users(username)`, `Users(email)`: 这些已经是 `UNIQUE`，通常数据库会自动创建索引，但需确认。
  - `Reviews(movie_id)`, `Reviews(user_id)`: 外键通常也会自动创建索引，但显式声明是个好习惯，特别是当它们是查询入口时。
- **推荐程度**: ★★★★☆ (高度推荐)
- **理由**: 索引是数据库性能优化的第一道防线，对于一个“资料库”系统至关重要。

##### **2.2. 外键的级联操作 (Cascading)**
- **问题**: 当一个实体被删除时，与之关联的数据该如何处理？例如，删除一个用户，他的评论怎么办？删除一部电影，它的评论、演职员关系怎么办？
- **解决方案**: 在定义外键时明确指定 `ON DELETE` 和 `ON UPDATE` 的行为。
- **实施**:
  - `Reviews` 表的 `user_id` 外键:
    - `ON DELETE SET NULL`: 删除用户后，其评论保留但 `user_id` 设为 `NULL`（匿名评论）。
    - `ON DELETE CASCADE`: 删除用户后，其所有评论一并删除。**（通常更推荐此方案）**
  - `Reviews` 表的 `movie_id` 外键:
    - `ON DELETE CASCADE`: 删除电影后，其所有评论也应被删除。
- **推荐程度**: ★★★★☆ (高度推荐)
- **理由**: 保证了数据的引用完整性，避免了“孤儿数据”的产生，使系统行为更可预测。

---

### 结论

你的设计文档**非常出色**，已经构建了一个坚实、合理且可扩展的骨架。它**绝对可以开始开发了**。



系统**主要功能**如下：

（1）**用户与权限管理**：分为管理员 (Admin) 和普通用户 (User)（用户ID、用户名、邮箱、密码哈希、角色）。管理员可以进行系统的所有数据维护操作（增删改电影、参与人、影评）；而普通用户只能进行数据查询、发布和管理自己的影评。

（2）**核心资料库管理**：由管理员维护电影、参与人和类型三大核心实体。 

* 电影 (Movies) 信息：电影ID、标题、简介、上映日期、时长（分钟）、海报链接。 
* 参与人 (People) 信息：参与人ID、姓名、简介、出生日期、照片链接（此实体统一管理演员和导演）。 
* 类型 (Genres) 信息：类型ID、类型名称（如：科幻、剧情）。 
* 管理员负责维护上述信息及它们之间的关联（如：为电影添加演职人员、为电影分配类型）。

（3）**电影搜索与查询**：按电影标题、参与人姓名（演员或导演）、电影类型为条件查询电影的详细信息。查询结果需包含电影详情、演职员列表、所属类型、平均分和影评列表。

（4）**影评与统计管理**：  

- 普通用户可以对电影发布影评（包含1-10分的评分和评论内容）。 

- 影评发布、修改或删除后，系统自动实时更新电影表中的“平均分”(average_rating) 和“评分人数”(rating_count)。 

- 系统根据所有电影的“平均分”高低，自动统计生成“评分Top 100电影榜单”。

（5）**系统管理**：包括用户注册、用户登录、更改密码。管理员拥有额外权限，可以查看用户列表、修改用户角色（提升为管理员或降级为普通用户）以及删除用户账户。





## 项目背景

从目前社会互联网的趋势可以得出，数字内容与流媒体服务（如 Netflix, Disney+, Apple TV+）已成为全球文化消费的核心。电影和剧集的生产、发行与消费速度达到了前所未有的高度，这直接导致了严重的“**信息过载**”问题。为了顺应时代的变化，如何将这些海量的影视资源进行有效的结构化组织、归档、查询和推荐，以实现最大化的用户触达和数据价值，变得至关重要。

产品走上系统的管理是在这种“内容爆炸”的时代影响下显现出来的。在如今计算机快速发展、数据库技术成为基础架构的情况下，人们的生活节奏越来越快，原先那种信息渠道分散、查询低效的方式已经不再能满足用户的需求。例如，用户可能需要在一个平台（如 IMDb）查询评分，在另一个平台（如烂番茄）查看专业影评，最后还要去各个流媒体平台搜索内容是否上线。

为了适应当前的发展趋势，并为广大影迷、影评人和数据管理者提供便利，我们选择开发一个“电影资料库管理系统 (MDMS)”。该系统可以为用户提供便捷、统一、高效的电影信息查询服务，极大地节约用户的时间和精力。系统用户可以快速便捷地查询电影详情、演职人员作品集、查看评分、发布和浏览影评；系统也能自动统计并生成“Top 100 榜单”；同时，管理员可以对整个资料库的数据进行专业、高效的维护和管理。
